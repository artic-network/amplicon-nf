{# Viral Amplicon QC Report â€” Jinja2 template (patched) #}
<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
  <meta charset="UTF-8"> 
  <link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg viewBox='2250 2250 500 500' width='330px' height='330px' xmlns='http://www.w3.org/2000/svg'%3E%3Cstyle%3E%3C!--ARTIC blue: %23005C68 --%3E%3C!--ARTIC yellow: %23F6EECA --%3E%3C!--ARTIC red: %23F1605D --%3E .logo-compass-line %7B fill: none; stroke: %23F6EECA; stroke-width:0.5 %7D .logo-globe-line %7B fill: none; stroke: %23F6EECA; stroke-width:0.5 %7D .logo-epi-line %7B fill: none; stroke: %23F6EECA; stroke-width:5 %7D .logo-epi-circle %7B fill: %23F1605D; stroke: %23F6EECA; stroke-width:5 %7D .logo-central-circle %7B fill: %23F1605D; stroke: %23F6EECA; stroke-width:5 %7D .logo-virus %7B fill: %23F6EECA; stroke: none %7D %3C/style%3E%3Cg%3E%3Cg%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='193.4'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='162.1'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='180.1'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='204.1'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='211.4'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='216.9'/%3E%3Ccircle class='logo-globe-line' cx='2500' cy='2500' r='134.8'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cline class='logo-epi-line' x1='2350.5' y1='2424.1' x2='2332.9' y2='2432.7'/%3E%3Cline class='logo-epi-line' x1='2368.4' y1='2403' x2='2374.6' y2='2378.2'/%3E%3Cline class='logo-epi-line' x1='2514.4' y1='2325.3' x2='2546.9' y2='2313.5'/%3E%3Cline class='logo-epi-line' x1='2457.3' y1='2313.8' x2='2485.8' y2='2324.9'/%3E%3Cline class='logo-epi-line' x1='2514.2' y1='2659.6' x2='2560.6' y2='2682'/%3E%3Cline class='logo-epi-line' x1='2469.7' y1='2664.7' x2='2485.6' y2='2658.5'/%3E%3Cline class='logo-epi-line' x1='2500.1' y1='2399.2' x2='2500.1' y2='2346.4'/%3E%3Cline class='logo-epi-line' x1='2651.4' y1='2408.8' x2='2586.6' y2='2448.4'/%3E%3Cline class='logo-epi-line' x1='2619.8' y1='2571.7' x2='2586.4' y2='2552'/%3E%3Cline class='logo-epi-line' x1='2500.1' y1='2637.8' x2='2500.1' y2='2600.8'/%3E%3Cline class='logo-epi-line' x1='2413.6' y1='2551.9' x2='2332.9' y2='2599.1'/%3E%3Cline class='logo-epi-line' x1='2413.6' y1='2448.1' x2='2377.9' y2='2426.1'/%3E%3Cline class='logo-epi-line' x1='2646.5' y1='2587.3' x2='2660.2' y2='2595.4'/%3E%3Cg%3E%3Ccircle class='logo-epi-circle' cx='2633.1' cy='2579.5' r='16'/%3E%3Ccircle class='logo-epi-circle' cx='2500.2' cy='2331' r='15.5'/%3E%3Ccircle class='logo-epi-circle' cx='2364.8' cy='2418.1' r='15.2'/%3E%3Ccircle class='logo-epi-circle' cx='2664.6' cy='2400.8' r='15.5'/%3E%3Ccircle class='logo-epi-circle' cx='2319.6' cy='2606.9' r='15.6'/%3E%3Ccircle class='logo-epi-circle' cx='2322.9' cy='2437.5' r='11.1'/%3E%3Ccircle class='logo-epi-circle' cx='2377.3' cy='2367.4' r='11.1'/%3E%3Ccircle class='logo-epi-circle' cx='2446.9' cy='2309.7' r='11.2'/%3E%3Ccircle class='logo-epi-circle' cx='2557.4' cy='2309.7' r='11.2'/%3E%3Ccircle class='logo-epi-circle' cx='2459.3' cy='2668.7' r='11.1'/%3E%3Ccircle class='logo-epi-circle' cx='2669.8' cy='2601' r='11.1'/%3E%3Ccircle class='logo-epi-circle' cx='2499.9' cy='2653.2' r='15.5'/%3E%3Ccircle class='logo-epi-circle' cx='2570.7' cy='2686.8' r='11.1'/%3E%3C/g%3E%3Ccircle class='logo-central-circle' cx='2500.2' cy='2500' r='100'/%3E%3C/g%3E%3Cg%3E%3Cpolygon class='logo-virus' points='2501.2,2564.6 2501.3,2588.9 2571.8,2549.8 '/%3E%3Cpolygon class='logo-virus' points='2428.7,2549.3 2499.3,2588.8 2499.2,2564.6 '/%3E%3Cpolygon class='logo-virus' points='2554.4,2470.9 2502.2,2562.4 2576.8,2546.7 '/%3E%3Cpolygon class='logo-virus' points='2423.6,2546.1 2498.2,2562.3 2445.4,2470.9 '/%3E%3Cpolygon class='logo-virus' points='2446.9,2469.3 2500.2,2561.8 2553,2469.3 '/%3E%3Cpolygon class='logo-virus' points='2555.9,2468.8 2577.1,2540.5 2577.1,2456.3 '/%3E%3Cpolygon class='logo-virus' points='2423.3,2539.9 2444,2468.8 2423.3,2456.6 '/%3E%3Cpolygon class='logo-virus' points='2447.4,2467.3 2552.4,2467.3 2500.3,2411.2 '/%3E%3Cpolygon class='logo-virus' points='2554.8,2467.3 2555.3,2466.8 2576.1,2454.5 2505.6,2413.9 2554.5,2466.6 '/%3E%3Cpolygon class='logo-virus' points='2424.3,2454.8 2444.5,2466.8 2445,2466.8 2445.3,2466.7 2494.9,2414 '/%3E%3C/g%3E%3C/svg%3E" />
  <title>{{ sample_id }} - QC Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    {{ bootstrap_css | safe }}
  </style>

  <style>
    :root {
      --color-teal-dark: #345c67;
      --color-teal-light: #4f7c8a;
      --color-cream: #f3edca;
      --color-coral: #d3615e;
      --color-orange: #f7b26f;
      --color-tab-inactive: #e9e1b8;
      --color-qc-pass: #4caf50;
      --color-qc-warning: #ffff00;
      --color-qc-fail: #f44336;
    }

    body {
      background-color: var(--color-cream);
      color: #102a33;
      font-family: "Roboto", sans-serif;
    }

    @page {
      size: A4 portrait;
    }

    .header-bar,
    .footer-bar {
      background-color: var(--color-teal-dark);
      color: var(--color-cream);
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      margin-bottom: 3rem;
    }

    .footer-bar a {
      text-decoration: underline;
      color: var(--color-cream);
    }

    .badge-pass {
      background-color: var(--color-qc-pass);
      color: #212529;
    }

    .badge-warning {
      background-color: var(--color-qc-warning);
      color: #212529;
    }

    .badge-fail {
      background-color: var(--color-qc-fail);
      color: #212529;
    }

    .dropout-pass {
      color: var(--color-teal-light);
      font-weight: bold;
    }

    .dropout-fail {
      color: var(--color-coral);
      font-weight: bold;
    }

    .table-sm td,
    .table-sm th {
      padding: 0.3rem;
    }

    .btn-outline-secondary {
      border-color: var(--color-teal-dark);
      color: var(--color-teal-dark);
    }

    .btn-outline-secondary:hover {
      background-color: var(--color-teal-dark);
      color: var(--color-cream);
    }

    .logo-container {
      height: 150px;
      width: auto;
      display: flex;
      align-items: center;
    }

    .logo-container svg {
      height: 100%;
      width: auto;
    }

    .footer-logo {
      height: 100px;
      width: auto;
      display: flex;
      align-items: center;
    }

    .footer-logo svg {
      height: 100%;
      width: auto;
    }

    .plotly-graph-div {
      width: 100% !important;
      max-width: 100%;
      height: 800px !important;
    }

    .tab-content {
      width: 100%;
      overflow: hidden;
    }

    .tab-pane {
      width: 100%;
    }

    .nav-tabs {
      border-bottom: 1px solid var(--color-teal-dark);
    }

    .nav-tabs .nav-link {
      background-color: var(--color-tab-inactive);
      border: 1px solid var(--color-teal-dark);
      border-bottom: none;
      color: #102a33;
      margin-right: 0.25rem;
      border-radius: 0.5rem 0.5rem 0 0;
      margin-bottom: -1px;
    }

    .nav-tabs .nav-link:hover:not(.active) {
      background-color: var(--color-teal-light);
      color: var(--color-cream);
    }

    .nav-tabs .nav-link.active {
      background-color: white;
      color: var(--color-teal-dark);
      font-weight: bold;
      border-bottom-color: white;
    }
  </style>

  <script type="text/javascript">
    {{ plotly_js | safe }}
  </script>
</head>

<body>
  <div class="container py-4">
    <div class="header-bar d-flex align-items-center">
      <div class="logo-container me-3">{{ embedded_logo_svg | safe }}</div>
      <h1 class="h4 mb-0">ARTIC-network/amplicon-nf QC Report for: <strong>{{ sample_id }}</strong></h1>
    </div>

    <table class="table table-sm mt-3">
      <tbody>
        <tr>
          <th scope="row">Sample ID</th>
          <td>{{ sample_id }}</td>
        </tr>
        <tr>
          <th scope="row">Pipeline Version</th>
          <td>{{ pipeline_version }}</td>
        </tr>
        <tr>
          <th scope="row">Primer Scheme</th>
          <td>{{ primer_scheme_version }}</td>
        </tr>
        <tr>
          <th scope="row">Sequencing Platform</th>
          <td>{{ sequencing_platform }}</td>
        </tr>
        <tr>
          <th scope="row">Timestamp</th>
          <td>{{ timestamp }}</td>
        </tr>
      </tbody>
    </table>

    <ul class="nav nav-tabs" id="contigTabs" role="tablist">
      {% for contig in contigs %}
      <li class="nav-item" role="presentation">
        <button
          class="nav-link {% if loop.first %}active{% endif %}"
          id="tab-{{ loop.index0 }}"
          data-bs-toggle="tab"
          data-bs-target="#contig-{{ loop.index0 }}"
          type="button"
          role="tab"
        >
          {{ contig.name }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content border p-3 bg-white" id="contigTabsContent" style="border-top: none">
      {% for contig in contigs %}
      <div
        class="tab-pane fade {% if loop.first %}show active{% endif %}"
        id="contig-{{ loop.index0 }}"
        role="tabpanel"
      >
        <h5 class="mt-3">QC Summary</h5>
        <ul class="list-unstyled">
          <li><strong>Percent Coverage:</strong> {{ contig.percent_coverage }}%</li>
          <li><strong>Number of Amplicon Dropouts:</strong> {{ contig.total_amplicon_dropouts }}</li>
          <li>
            <strong>QC Status:</strong>
            {% if contig.qc_status == 'pass' %}
              <span class="badge badge-pass">HIGH PASS</span>
            {% elif contig.qc_status == 'warning' %}
              <span class="badge badge-warning">LOW PASS</span>
            {% elif contig.qc_status == 'fail' %}
              <span class="badge badge-fail">FAIL</span>
            {% else %}
              <span class="badge bg-secondary">UNKNOWN</span>
            {% endif %}
          </li>
          <li><span class="badge bg-info">Total Reads: {{ contig.total_reads }}</span></li>
          <li><span class="badge bg-secondary">Average Depth: {{ contig.average_depth }}</span></li>
        </ul>

        {{ contig.plotly_html | safe }}

        <button
          class="btn btn-outline-secondary btn-sm mt-3"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseAmplicons-{{ loop.index0 }}"
        >
          Show Amplicon Table
        </button>

        <div class="collapse" id="collapseAmplicons-{{ loop.index0 }}">
          <table class="table table-sm mt-2">
            <thead>
              <tr>
                <th>ID</th>
                <th>Start</th>
                <th>End</th>
                <th>Pool</th>
                <th>Mean Depth</th>
                <th>Amplicon Covered</th>
              </tr>
            </thead>
            <tbody>
              {% for amp_id, depth in contig.amplicon_mean_depths.items() %}
              <tr>
                <td>{{ amp_id }}</td>
                <td>{{ contig.amplicon_coords[amp_id].start }}</td>
                <td>{{ contig.amplicon_coords[amp_id].end }}</td>
                <td>{{ contig.amplicon_coords[amp_id].pool }}</td>
                <td>{{ depth }}</td>
                <td>
                  {% if amp_id in contig.amplicon_dropouts %}
                    <span class="dropout-fail">&#10006;</span>
                  {% else %}
                    <span class="dropout-pass">&#10004;</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>

    <footer class="footer-bar d-flex justify-content-between align-items-center mt-4">
      <div>
        <p class="mb-0"><strong>{{ tool_name }} {{ tool_version }}</strong> | Generated on {{ timestamp }}</p>
        <p class="mb-0">
          <span class="badge bg-light text-dark">MIT License</span> |
          <a href="{{ citation_link }}">Citation</a> |
          <a href="https://github.com/artic-network/amplicon-nf/issues/new/choose">Have a problem? Report it here</a> |
          <a href="https://github.com/artic-network/amplicon-nf">Github Repository</a>
        </p>
        <p class="mb-0"><strong>{{ funder_statement }}</strong></p>
      </div>
      <div class="footer-logo ms-3">{{ embedded_logo_svg | safe }}</div>
    </footer>
  </div>

  <script type="text/javascript">
    {{ bootstrap_bundle_js | safe }}
  </script>

  <script type="text/javascript">
    function waitForContainerWidth(el, cb, retries = 10) {
      if (retries === 0) return;
      if (el.offsetWidth > 100) return cb();
      setTimeout(() => waitForContainerWidth(el, cb, retries - 1), 100);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Handle initial active tab
      const initialTabPane = document.querySelector('.tab-pane.active');
      if (initialTabPane) {
        const plotDivs = initialTabPane.querySelectorAll('.plotly-graph-div');
        plotDivs.forEach((div) => {
          waitForContainerWidth(div, () => {
            Plotly.Plots.resize(div);
          });
        });
      }

      // Existing tab switch handler
      const tabElList = document.querySelectorAll('button[data-bs-toggle="tab"]');
      tabElList.forEach(function(tabEl) {
        tabEl.addEventListener('shown.bs.tab', function(event) {
          const targetId = event.target.getAttribute('data-bs-target');
          const tabPane = document.querySelector(targetId);
          const plotDivs = tabPane.querySelectorAll('.plotly-graph-div');

          plotDivs.forEach((div) => {
            waitForContainerWidth(div, () => {
              Plotly.Plots.resize(div);
            });
          });
        });
      });
    });
  </script>
</body>
</html>
